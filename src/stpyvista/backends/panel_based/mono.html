<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ðŸ§Š stpyvista ðŸ§Š</title>
    <script>

        // Borrowed minimalistic Streamlit API from Thiago
        // https://discuss.streamlit.io/t/code-snippet-create-components-without-any-frontend-tooling-no-react-babel-webpack-etc/13064
        function sendMessageToStreamlitClient(type, data) {
            console.log(type, data)
            const outData = Object.assign({
                isStreamlitMessage: true,
                type: type,
            }, data);
            window.parent.postMessage(outData, "*");
        }

        const Streamlit = {
            setComponentReady: function () {
                sendMessageToStreamlitClient("streamlit:componentReady", { apiVersion: 1 });
            },
            setFrameHeight: function (height) {
                sendMessageToStreamlitClient("streamlit:setFrameHeight", { height: height });
            },
            setComponentValue: function (value) {
                sendMessageToStreamlitClient("streamlit:setComponentValue", { value: value });
                // sendMessageToStreamlitClient("streamlit:setComponentValue", {value});  
            },
            RENDER_EVENT: "streamlit:render",
            events: {
                addEventListener: function (type, callback) {
                    window.addEventListener("message", function (event) {
                        if (event.data.type === type) {
                            event.detail = event.data
                            callback(event);
                        }
                    });
                }
            }
        }

    </script>
    <script>
        // The `Streamlit` object exists because our html file includes
        // `streamlit-component-lib.js`.
        // If you get an error about "Streamlit" not being defined, that
        // means you're missing that file.

        function sendValue(value) {
            Streamlit.setComponentValue(value)
        }

        /**
         * The component's render function. This will be called immediately after
         * the component is initially loaded, and then again every time the
         * component gets new data from Python.
         */
        function onRender(event) {

            // Only run the render code the first time the component is loaded.
            if (!window.rendered) {

                // You most likely want to get the data passed in like this
                const { panel_html, height, width, horizontal_align, use_container_width, bgcolor, key } = event.detail.args;

                const mainframe = window.parent.document.querySelector('iframe[title="stpyvista.panel_backend.stpyvista_panel"]');
                mainframe.title = "stpyvista.rendered"

                // const stpyvistadiv = document.getElementById("stpyvistadiv");
                const stpyvistaframe = document.getElementById("stpyvistaframe");
                const fullscreen_height = window.screen.height;

                // Style the wrapping div for the iframe
                mainframe.parentElement.style.textAlign = horizontal_align;
                mainframe.contentDocument.querySelector('body').style.backgroundColor = bgcolor;


                function updateFrameWidth() {
                    // delete mainframe.width;
                    stpyvistaframe.width = document.body.offsetWidth + 20;
                }

                if (Boolean(use_container_width)) {
                    updateFrameWidth();

                    window.onresize = function (event) {
                        updateFrameWidth();
                    }
                } else {
                    mainframe.width = width + 10;
                    stpyvistaframe.width = width + 16;
                }

                function fullscreenchanged(event) {

                    if (document.fullscreenElement) {
                        updateFrameWidth();

                        stpyvistaframe.height = fullscreen_height - 4;
                        Streamlit.setFrameHeight(fullscreen_height);

                    } else {
                        if (Boolean(use_container_width)) {
                            updateFrameWidth();
                        } else {
                            mainframe.width = width + 10;
                            stpyvistaframe.width = width + 16;
                        }

                        stpyvistaframe.height = height;
                        Streamlit.setFrameHeight(height + 4);
                    }
                }

                document.addEventListener("fullscreenchange", fullscreenchanged);

                stpyvistaframe.srcdoc = panel_html;
                stpyvistaframe.scrolling = "yes";

                stpyvistaframe.height = height;
                Streamlit.setFrameHeight(height);

                // Send some value to python 
                // Not very useful at the moment but keep it for later
                // stpyvistadiv.addEventListener('click', event => sendValue(50), false);

                window.rendered = true;

            }
        }

        // Render the component whenever python send a "render event"
        Streamlit.events.addEventListener(Streamlit.RENDER_EVENT, onRender)

        // Tell Streamlit that the component is ready to receive events
        Streamlit.setComponentReady()

        // Render with the correct height, if this is a fixed-height component
        Streamlit.setFrameHeight()
    </script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
        }

        #stpyvistadiv {
            text-align: center;
            display: block;
            margin-left: 0px;
            margin-right: 0px;
            width: 100%;
            background-color: rgba(255, 0, 0, 0);
        }

        #toggle-fullscreen {
            background-color: #ffffff4e;
            border: #ffffff00 solid 0px;
            border-radius: 10%;
            font-size: 24px;
            position: absolute;
            top: 10px;
            right: calc(100% - (100% - 10px));
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0.5;
            transition: 0.3s;
        }

        #toggle-fullscreen:hover {
            box-shadow: 0 12px 16px 0 rgba(0, 0, 0, 0.24), 0 17px 50px 0 rgba(0, 0, 0, 0.19);
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div id="stpyvistadiv">
        <button id="toggle-fullscreen" onclick="openFullscreen();">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                class="bi bi-arrows-fullscreen" viewBox="0 0 16 16">
                <path fill-rule="evenodd"
                    d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707m-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707" />
            </svg>
        </button>
        <iframe id="stpyvistaframe"
            sandbox="allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-downloads"
            frameborder="0" allowfullscreen allowtransparency="true"></iframe>
    </div>
    <script>
        var elem = document.documentElement;
        var btn = document.getElementById("toggle-fullscreen")

        function openFullscreen() {
            if (document.fullscreenElement) {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) { /* Safari */
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { /* IE11 */
                    document.msExitFullscreen();
                }
            } else {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    elem.msRequestFullscreen();
                }
            }
        }

        function updateButton() {
            // Icons from https://icons.getbootstrap.com/icons
            if (document.fullscreenElement) {
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-fullscreen-exit" viewBox="0 0 16 16"><path d="M5.5 0a.5.5 0 0 1 .5.5v4A1.5 1.5 0 0 1 4.5 6h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5m5 0a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 10 4.5v-4a.5.5 0 0 1 .5-.5M0 10.5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 6 11.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5m10 1a1.5 1.5 0 0 1 1.5-1.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0z"/></svg>';
            } else {
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16"> <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707m-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707"/></svg>';
            }

        }

        document.addEventListener("fullscreenchange", updateButton);
    </script>
</body>

</html>